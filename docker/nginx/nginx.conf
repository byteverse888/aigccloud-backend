events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # 日志格式
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;
    error_log   /var/log/nginx/error.log;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    # 上游服务
    upstream frontend {
        server frontend:3000;
    }

    upstream parse_server {
        server parse-server:1337;
    }

    upstream cloudendapi {
        server cloudendapi:8000;
    }

    upstream rustfs {
        server rustfs:9000;
    }

    # ============ 安全配置 ============
    
    # 管理后台IP白名单（可根据实际情况修改）
    geo $admin_allowed {
        default 0;
        127.0.0.1 1;
        10.0.0.0/8 1;      # 内网
        172.16.0.0/12 1;   # 内网
        192.168.0.0/16 1;  # 内网
        # 添加允许访问的公网IP
        # 1.2.3.4 1;
    }

    # HTTP 服务器
    server {
        listen 80;
        server_name localhost;

        # 前端应用（非管理后台）
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # ============ 管理后台访问限制 ============
        # /admin 路径需要IP白名单 + Basic Auth 双重验证
        location /admin {
            # IP白名单检查
            if ($admin_allowed = 0) {
                return 403;
            }
            
            # Basic Auth 认证
            auth_basic "Admin Area - Restricted Access";
            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;
            
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Parse Dashboard 也需要限制访问
        location /dashboard {
            if ($admin_allowed = 0) {
                return 403;
            }
            
            auth_basic "Parse Dashboard - Restricted Access";
            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;
            
            proxy_pass http://parse-server:4040/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Parse Server API（仅允许内部访问，外部通过FastAPI中转）
        location /parse/ {
            # 限制仅内网访问Parse API
            allow 10.0.0.0/8;
            allow 172.16.0.0/12;
            allow 192.168.0.0/16;
            allow 127.0.0.1;
            deny all;
            
            proxy_pass http://parse_server/parse/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # CloudendAPI - 对外开放
        location /api/ {
            proxy_pass http://cloudendapi/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 安全头
            add_header X-Content-Type-Options nosniff;
            add_header X-Frame-Options DENY;
            add_header X-XSS-Protection "1; mode=block";
        }

        # API 文档（限制访问）
        location /docs {
            if ($admin_allowed = 0) {
                return 403;
            }
            
            proxy_pass http://cloudendapi/docs;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /redoc {
            if ($admin_allowed = 0) {
                return 403;
            }
            
            proxy_pass http://cloudendapi/redoc;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /openapi.json {
            if ($admin_allowed = 0) {
                return 403;
            }
            
            proxy_pass http://cloudendapi/openapi.json;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # ============ RustFS 对象存储 ============
        # S3 API 代理
        location /s3/ {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 300;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;

            # 文件上传大小限制
            client_max_body_size 1G;

            # 重写路径，移除 /s3 前缀
            rewrite ^/s3/(.*) /$1 break;
            proxy_pass http://rustfs;
        }

        # RustFS Console 管理界面（限制访问）
        location /rustfs-console/ {
            if ($admin_allowed = 0) {
                return 403;
            }

            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_pass http://rustfs:9001/;
        }

        # 安全：禁止访问隐藏文件
        location ~ /\. {
            deny all;
        }
    }
}
